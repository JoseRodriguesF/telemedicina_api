generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id           Int         @id @default(autoincrement())
  email        String      @unique @db.VarChar(255)
  senha_hash   String?     @db.VarChar(255)
  google_id    String?     @unique @map("google_id") @db.VarChar(255)
  registroFull Boolean     @default(false) @map("registro_full")
  tipo_usuario TipoUsuario
  medico       Medico?
  paciente     Paciente?
  enderecos    Endereco[]

  @@map("usuarios")
}

model Paciente {
  id                   Int      @id @default(autoincrement())
  usuario_id           Int      @unique
  nome_completo        String   @db.VarChar(255)
  data_nascimento      DateTime @db.Date
  cpf                  String   @unique @db.VarChar(14)
  sexo                 String   @db.VarChar(20)
  estado_civil         String   @db.VarChar(50)
  telefone             String   @db.VarChar(11)
  responsavel_legal    String?  @db.VarChar(255)
  telefone_responsavel String?  @db.VarChar(20)
  usuario              Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  consultas            Consulta[] @relation("ConsultaPaciente")
  historiaClinica      HistoriaClinica[]

  @@map("pacientes")
}

model Medico {
  id                          Int      @id @default(autoincrement())
  usuario_id                  Int      @unique
  nome_completo               String   @db.VarChar(255)
  data_nascimento             DateTime @db.Date
  cpf                         String   @unique @db.VarChar(14)
  sexo                        String?  @db.VarChar(20)
  crm                         String   @db.VarChar(50)
  diploma_url                 String?  @db.VarChar(255)
  especializacao_url          String?  @db.VarChar(255)
  assinatura_digital_url      String?  @db.VarChar(255)
  seguro_responsabilidade_url String?  @db.VarChar(255)
  verificacao                 StatusVerificacao @default(analise)
  usuario                     Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  consultas                   Consulta[] @relation("ConsultaMedico")

  @@map("medicos")
}

model Endereco {
  id          Int      @id @default(autoincrement())
  usuario_id  Int
  endereco    String
  numero      Int
  complemento String?

  usuario     Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("enderecos")
}

enum TipoUsuario {
  medico
  paciente
  admin

  @@map("tipo_usuario_enum")
}

enum StatusVerificacao {
  analise
  verificado
  recusado

  @@map("status_verificacao_enum")
}

enum ConsultaStatus {
  scheduled
  agendada
  in_progress
  finished
  solicitada

  @@map("consulta_status_enum")
}

model Consulta {
  id          Int             @id @default(autoincrement())
  medicoId    Int?            @map("medico_id")
  pacienteId  Int             @map("paciente_id")
  status      ConsultaStatus
  data_consulta DateTime?     @map("data_consulta") @db.Date
  hora_inicio  DateTime?      @map("hora_inicio") @db.Time
  hora_fim     DateTime?      @map("hora_fim") @db.Time
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  resumo        String?         @db.Text
  repouso       String?         @db.Text
  destino_final String?         @map("destino_final") @db.Text
  diagnostico   String?         @db.Text
  evolucao      String?         @db.Text
  plano_terapeutico String?     @map("plano_terapeutico") @db.Text

  medico      Medico?         @relation(name: "ConsultaMedico", fields: [medicoId], references: [id], onDelete: Cascade)
  paciente    Paciente        @relation(name: "ConsultaPaciente", fields: [pacienteId], references: [id], onDelete: Cascade)
  historiaClinica HistoriaClinica[]

  @@index([medicoId], name: "idx_consultas_medico_id")
  @@index([pacienteId], name: "idx_consultas_paciente_id")
  @@index([medicoId, pacienteId], name: "idx_consultas_medico_paciente")
  @@map("consultas")
}

model HistoriaClinica {
  id                      Int      @id @default(autoincrement())
  pacienteId              Int      @map("paciente_id")
  consultaId              Int?     @map("consulta_id")
  queixaPrincipal         String   @map("queixa_principal") @db.Text
  descricaoSintomas       String?  @map("descricao_sintomas") @db.Text
  historicoPessoal        Json?    @default("{}") @map("historico_pessoal") @db.JsonB
  antecedentesFamiliares  Json?    @default("{}") @map("antecedentes_familiares") @db.JsonB
  estiloVida              Json?    @default("{}") @map("estilo_vida") @db.JsonB
  historicoVacinacao      String?  @map("historico_vacinacao") @db.Text
  observacoesGerais       String?  @map("observacoes_gerais") @db.Text
  status                  String   @default("rascunho") @db.VarChar(20)
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  paciente         Paciente  @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  consulta         Consulta? @relation(fields: [consultaId], references: [id], onDelete: SetNull)
  @@index([pacienteId], name: "idx_historiaclinica_paciente_id")
  @@index([consultaId], name: "idx_historiaclinica_consulta_id")
  @@index([status], name: "idx_historiaclinica_status")
  @@map("historiaClinica")
}

