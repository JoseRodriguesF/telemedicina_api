generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id           Int         @id @default(autoincrement())
  email        String      @unique @db.VarChar(255)
  senha_hash   String?     @db.VarChar(255)
  google_id    String?     @unique @map("google_id") @db.VarChar(255)
  registroFull Boolean     @default(false) @map("registro_full")
  tipo_usuario TipoUsuario
  enderecos    Endereco[]
  medico       Medico?
  paciente     Paciente?

  @@map("usuarios")
}

model Paciente {
  id                    Int               @id @default(autoincrement())
  usuario_id            Int               @unique
  nome_completo         String            @db.VarChar(255)
  data_nascimento       DateTime          @db.Date
  cpf                   String            @unique @db.VarChar(14)
  sexo                  String            @db.VarChar(20)
  estado_civil          String            @db.VarChar(50)
  telefone              String            @db.VarChar(11)
  responsavel_legal     String?           @db.VarChar(255)
  telefone_responsavel  String?           @db.VarChar(20)
  notas                 String?
  historiaClinicaResumo String?           @map("historia_clinica")
  consultas             Consulta[]        @relation("ConsultaPaciente")
  historiaClinica       HistoriaClinica[]
  usuario               Usuario           @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("pacientes")
}

model Medico {
  id                               Int               @id @default(autoincrement())
  usuario_id                       Int               @unique
  nome_completo                    String            @db.VarChar(255)
  data_nascimento                  DateTime          @db.Date
  cpf                              String            @unique @db.VarChar(14)
  sexo                             String?           @db.VarChar(20)
  crm                              String            @db.VarChar(50)
  diploma_url                      String?           @db.VarChar(255)
  especializacao_url               String?           @db.VarChar(255)
  assinatura_digital_url           String?           @db.VarChar(255)
  seguro_responsabilidade_url      String?           @db.VarChar(255)
  verificacao                      StatusVerificacao @default(analise)
  avaliacao                        Float?            @default(0)
  assinatura_digital_data          Bytes?
  assinatura_digital_mimetype      String?           @db.VarChar(100)
  diploma_data                     Bytes?
  diploma_mimetype                 String?           @db.VarChar(100)
  especializacao_data              Bytes?
  especializacao_mimetype          String?           @db.VarChar(100)
  seguro_responsabilidade_data     Bytes?
  seguro_responsabilidade_mimetype String?           @db.VarChar(100)
  resumo_profissional              String?
  consultas                        Consulta[]        @relation("ConsultaMedico")
  usuario                          Usuario           @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("medicos")
}

model Endereco {
  id          Int     @id @default(autoincrement())
  usuario_id  Int
  endereco    String  @db.VarChar(255)
  numero      String? @db.VarChar(20)
  complemento String? @db.VarChar(255)
  bairro      String? @db.VarChar(100)
  cep         String? @db.VarChar(10)
  cidade      String? @db.VarChar(100)
  estado      String? @db.VarChar(2)
  usuario     Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@map("enderecos")
}

model Consulta {
  id                Int               @id @default(autoincrement())
  medicoId          Int?              @map("medico_id")
  pacienteId        Int               @map("paciente_id")
  status            ConsultaStatus
  data_consulta     DateTime?         @map("data_consulta") @db.Date
  hora_inicio       DateTime?         @map("hora_inicio") @db.Time(6)
  hora_fim          DateTime?         @map("hora_fim") @db.Time(6)
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  resumo            String?
  repouso           String?
  destino_final     String?           @map("destino_final")
  diagnostico       String?
  evolucao          String?
  plano_terapeutico String?           @map("plano_terapeutico")
  avaliacao         String?
  estrelas          Int?
  medico            Medico?           @relation("ConsultaMedico", fields: [medicoId], references: [id], onDelete: Cascade)
  paciente          Paciente          @relation("ConsultaPaciente", fields: [pacienteId], references: [id], onDelete: Cascade)
  historiaClinica   HistoriaClinica[]
  prescricoes       Prescricao[]

  @@index([medicoId], map: "idx_consultas_medico_id")
  @@index([pacienteId], map: "idx_consultas_paciente_id")
  @@index([medicoId, pacienteId], map: "idx_consultas_medico_paciente")
  @@map("consultas")
}

model HistoriaClinica {
  id                     Int       @id @default(autoincrement())
  pacienteId             Int       @map("paciente_id")
  consultaId             Int?      @map("consulta_id")
  status                 String    @default("rascunho") @db.VarChar(20)
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  conteudo               String
  antecedentesFamiliares Json?     @map("antecedentes_familiares")
  descricaoSintomas      String?   @map("descricao_sintomas")
  estiloVida             Json?     @map("estilo_vida")
  historicoPessoal       Json?     @map("historico_pessoal")
  queixaPrincipal        String?   @map("queixa_principal")
  consulta               Consulta? @relation(fields: [consultaId], references: [id])
  paciente               Paciente  @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  @@index([pacienteId], map: "idx_historiaclinica_paciente_id")
  @@index([consultaId], map: "idx_historiaclinica_consulta_id")
  @@index([status], map: "idx_historiaclinica_status")
  @@map("historiaClinica")
}

model Prescricao {
  id              Int      @id @default(autoincrement())
  consultaId      Int      @map("consulta_id")
  medicamento     String   @db.VarChar(255)
  marca           String?  @db.VarChar(255)
  dosagem         String
  frequencia      String
  duracao         String
  inclusoConvenio Boolean  @default(false) @map("incluso_convenio")
  pdf_data        Bytes?   @map("pdf_data")
  pdf_mimetype    String?  @map("pdf_mimetype") @db.VarChar(100)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  consulta        Consulta @relation(fields: [consultaId], references: [id], onDelete: Cascade)

  @@index([consultaId], map: "idx_prescricoes_consulta_id")
  @@map("prescricoes")
}

enum TipoUsuario {
  medico
  paciente
  admin

  @@map("tipo_usuario_enum")
}

enum StatusVerificacao {
  analise
  verificado
  recusado

  @@map("status_verificacao_enum")
}

enum ConsultaStatus {
  scheduled
  agendada
  in_progress
  finished
  solicitada
  cancelled

  @@map("consulta_status_enum")
}
